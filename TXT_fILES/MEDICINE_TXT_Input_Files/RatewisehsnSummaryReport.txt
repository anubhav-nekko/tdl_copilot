;===============================================================================
; RATEWISEHSNSUMMARYREPORT.TXT
; Created By: Khokan on 2019-06-18 11:51, ID:
; Purpose: GST Rate-wise HSN Summary report for Tally, showing HSN, UQC, GST rate,
;          quantity, taxable value, and tax breakup for each stock item.
;===============================================================================

;------------------------------------------------------------------------------
; MENU INTEGRATION (OPTIONAL)
;------------------------------------------------------------------------------

[#menu: Gateway of Tally]
;; {18.Jun.19 13:23} add: Option: RatewisehsnSummaryLock ;; : @@RatewisehsnSummaryDemoLock

[!menu: RatewisehsnSummaryLock]
    add: Item: before: @@locQuit: @@RatewisehsnSummaryReport: Display: RepRatewisehsnSummary
    add: Item: before: @@locQuit: Blank

[System: formula]
RatewisehsnSummaryReport: "Rate Wise HSN Summary"
;; RatewisehsnSummaryDemoLock: $$MachineDate < $$Date:"01/04/2013"

;------------------------------------------------------------------------------
; MAIN REPORT AND FORM
;------------------------------------------------------------------------------

[Report: RepRatewisehsnSummary]
    use: Dsp Template
    Title: @@RatewisehsnSummaryReport
    Printset: Report Title: @@RatewisehsnSummaryReport
    Form: FrmRatewisehsnSummary
    Export: Yes
    set: svfromdate : ##svcurrentdate
    set: svTodate   : ##svcurrentdate
    Local: Button: RelReports: Inactive: Yes

[Form: FrmRatewisehsnSummary]
    use: DSP Template
    Part: DspAccTitles, PrtTitle0RatewisehsnSummary, PrtRatewisehsnSummary
    Width: 100% Page
    Height: 100% Page
    Background: @@SV_STOCKSUMMARY
    delete: page break
    add: page break: RatewisehsnSummarybotbrk, RatewisehsnSummarybotOpbrk
    Bottom Toolbar Buttons: BottomToolBarBtn1, BottomToolBarBtn3, BottomToolBarBtn8, BottomToolBarBtn9, BottomToolBarBtn10, BottomToolBarBtn11, BottomToolBarBtn12

[part: RatewisehsnSummarybotBrk]
    line: EXPINV PageBreak
    border: thin top

[part: RatewisehsnSummarybotopbrk]
    use: dspacctitles
    add: part: RatewisehsnSummaryTitlePart

[part: RatewisehsnSummaryTitlePart]
    line: LnRatewisehsnSummaryTitle

[part: PrtTitle0RatewisehsnSummary]
    line: LnRatewisehsnSummaryCurrPeriod

[line: LnRatewisehsnSummaryCurrPeriod]
    field: fwf, fwf2
    Local: field: fwf2: Align: Right
    Local: Field: fwf: Style: normal bold
    Local: Field: fwf2: Style: normal bold
    Local: Field: fwf2: Set As: @@dspDateStr
    invisible: $$inprintmode

[Part: PrtRatewisehsnSummary]
    Line: LnRatewisehsnSummaryTitle, LnRatewisehsnSummary
    bottom Line: LnRatewisehsnSummaryTotals
    repeat: LnRatewisehsnSummary: ColRatewisehsnSummary
    scroll: Vertical
    Common Border: Yes
    Total: Qtyf, amtf, amtf1, amtf2, amtf3, amtf4, amtf5, numf

;------------------------------------------------------------------------------
; DATA COLLECTIONS
;------------------------------------------------------------------------------

[Collection: ColRatewisehsnSummary]
    source Collection: sourColRatewisehsnSummary
    walk: inventoryentries
    by: stockitemname: $stockitemname
    by: STATENAME1: $STATENAME
    aggr compute: billedqty: sum: $billedqty
    aggr compute: amount: sum: $amount
    compute: cwInvGSTItemAssValue1: @@cwInvGSTItemAssValue
    compute: gstrate1: $$cwGetGSTRateForInclusivex:$stockitemname
    compute: cwitemHSNCode1: @@cwitemHSNCode
    sort: @@default: $cwitemHSNCode1

[Collection: sourColRatewisehsnSummary]
    Use: Vouchers of Company
    delete: filter: daybookfilter
    Filter: ColRatewisehsnSummaryFilter, IsNonOptionalCancelledVchs

[system: Formula]
ColRatewisehsnSummaryFilter: $$issales:$vouchertypename

;------------------------------------------------------------------------------
; COLUMN HEADERS
;------------------------------------------------------------------------------

[Line: LnRatewisehsnSummaryTitle]
    use: LnRatewisehsnSummary
    option: titleopt
    local: field: Snf: set as: "HSN"
    local: field: fwf: set as: "Description"
    local: field: SNFX: set as: "UQC"
    local: field: numf: set as: "Total Quantity"
    local: field: numf2: set as: "GST Rate"
    local: field: amtf: set as: "Total Value"
    local: field: amtf2: set as: "Taxable Value"
    local: field: amtf3: set as: "Integrated Tax Amount"
    local: field: amtf4: set as: "Central Tax Amount"
    local: field: amtf5: set as: "State/UT Tax Amount"
    local: field: default: style: normal bold
    Local: field: default: Align: centre
    Local: field: fwf: Align: left

;------------------------------------------------------------------------------
; MAIN DATA LINE
;------------------------------------------------------------------------------

[Line: LnRatewisehsnSummary]
    Fields: snf, fwf, nf
    right field: snfx, numf, numf2, amtf, amtf2, amtf3, amtf4, amtf5, numf10, amtf6, amtf7, amtf8, amtf9, amtf10
    Option: Alter on Enter
    local: field: qtyf: Format: "NoSymbol, Short Form, No Compact,NoZero"
    local: field: ratepf: setas: #amtf/#qtyf
    local: field: fwf: alter: voucher: $$isvoucher
    option: alter on enter
    local: field: fwf: alter: voucher: $$isvoucher
    local: field: nf: Invisible: yes
    local: field: Snf: set as: if $$line=1 then $cwitemHSNCode1 else if $cwitemHSNCode1 <> $$prevobj:$cwitemHSNCode1 then $cwitemHSNCode1 else ""
    local: field: fwf: set as: @@cwitemHSNdesc
    local: field: SNFX: set as: $baseunits:stockitem:$stockitemname
    local: field: nf: set as: $stockitemname
    local: field: NUMF: set as: $billedqty
    local: field: NUMF2: set as: $gstrate1
    local: field: amtf: set as: $amount
    local: field: amtf2: set as: $cwInvGSTItemAssValue1
    local: field: amtf3: set as: if $STATENAME1 = $statename:COMPANY:##SVCURRENTCOMPANY then "" else (#amtf2*#numf2)/100
    local: field: amtf4: set as: if $STATENAME1 = $statename:COMPANY:##SVCURRENTCOMPANY then (#amtf2*#numf2)/100 else ""
    local: field: amtf5: set as: if $STATENAME1= $statename:COMPANY:##SVCURRENTCOMPANY then (#amtf2*#numf2)/100 else ""
    Local: Field: numf10: Set As: if $$line=1 then #numf else if $cwitemHSNCode1 <> $$prevobj:$cwitemHSNCode1 then #numf else $$prevlinefield+#numf
    Local: Field: amtf6: Set As: if $$line=1 then #amtf else if $cwitemHSNCode1 <> $$prevobj:$cwitemHSNCode1 then #amtf else $$prevlinefield+#amtf
    Local: Field: amtf7: Set As: if $$line=1 then #amtf2 else if $cwitemHSNCode1 <> $$prevobj:$cwitemHSNCode1 then #amtf2 else $$prevlinefield+#amtf2
    Local: Field: amtf8: Set As: if $$line=1 then #amtf3 else if $cwitemHSNCode1 <> $$prevobj:$cwitemHSNCode1 then #amtf3 else $$prevlinefield+#amtf3
    Local: Field: amtf9: Set As: if $$line=1 then #amtf4 else if $cwitemHSNCode1 <> $$prevobj:$cwitemHSNCode1 then #amtf4 else $$prevlinefield+#amtf4
    Local: Field: amtf10: Set As: if $$line=1 then #amtf5 else if $cwitemHSNCode1 <> $$prevobj:$cwitemHSNCode1 then #amtf5 else $$prevlinefield+#amtf5
    local: field: amtf6: Invisible: yes
    local: field: amtf7: Invisible: yes
    local: field: amtf8: Invisible: yes
    local: field: amtf9: Invisible: yes
    local: field: amtf10: Invisible: yes
    local: field: numf10: Invisible: yes
    Local: Field: default: Border: thin right
    local: field: numf2: Invisible: yes
    Local: field: snf: Width: 10
    Local: field: snfx: Width: 10
    explode: subtotalexp: $$line = $$numitems or $cwitemHSNCode1 <> $$nextobj:$cwitemHSNCode1

;------------------------------------------------------------------------------
; SUB-TOTAL PART AND LINE
;------------------------------------------------------------------------------

[part: subtotalexp]
    line: subtotalexp

[line: subtotalexp]
    use: LnRatewisehsnSummary
    border: totals
    local: field: fwf: set as: "Sub - Total"
    local: field: sdf: set as: ""
    local: field: Snf: set as: ""
    local: field: SNFX: set as: ""
    local: field: NUMF: set as: #numf10
    local: field: amtf: set as: #amtf6
    local: field: amtf2: set as: #amtf7
    local: field: amtf3: set as: #amtf8
    local: field: amtf4: set as: #amtf9
    local: field: amtf5: set as: #amtf10
    local: field: numf10: set as: $$prevlinefield
    local: field: amtf6: set as: $$prevlinefield
    local: field: amtf7: set as: $$prevlinefield
    local: field: amtf8: set as: $$prevlinefield
    local: field: amtf9: set as: $$prevlinefield
    local: field: amtf10: set as: $$prevlinefield
    Local: Field: default: Style: Normal Bold
    Local: field: fwf: Align: Right
    delete: explode

;------------------------------------------------------------------------------
; GST RATE RESOLUTION FUNCTION
;------------------------------------------------------------------------------

[Function: cwGetGSTRateForInclusivex]
    parameter: myitemname: string
    returns: number
    20: return: $$collectionfield:@@cwGSTDETAILS:(-1):cwte1x

[System: Formula]
cwGSTDETAILS: $$CollectionField:@@cwSTATEWISEDETAILS:(-1):STATEWISEDETAILS
cwSTATEWISEDETAILS: $$FilterValue:$gstrate:RATEDETAILS:last:cwdutyheaditax
cwdutyheaditax: $GSTRATEDUTYHEAD = "Integrated Tax"

[Collection: cwte1x]
    type: GSTDETAILS : stockitem
    child of: ##myitemname
    fetch: *.*

;------------------------------------------------------------------------------
; TOTALS LINE
;------------------------------------------------------------------------------

[line: LnRatewisehsnSummaryTotals]
    use: LnRatewisehsnSummary
    option: totalOpt
    local: field: fwf: align: right
    local: field: default: style: normal bold
    local: field: qtyf: set as: $$total:qtyf
    local: field: fwf: set as: "Total"
    local: field: sdf: set as: ""
    local: field: Snf: set as: ""
    local: field: SNFX: set as: ""
    local: field: NUMF: set as: $$total:numf
    local: field: amtf: set as: $$total:amtf
    local: field: amtf2: set as: $$total:amtf2
    local: field: amtf3: set as: $$total:amtf3
    local: field: amtf4: set as: $$total:amtf4
    local: field: amtf5: set as: $$total:amtf5

;===============================================================================
; END OF FILE
;===============================================================================
