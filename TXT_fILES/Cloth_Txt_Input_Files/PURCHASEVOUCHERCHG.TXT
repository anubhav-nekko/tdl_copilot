; Created By: Khokan on 2021-06-21 12:34
; ID: 

;;===========================================================
;; This section sets conditions for the 'eiconsignee' field

[#field:eiconsignee]
; Add option 'vchrefpurcopt' only when the voucher is a purchase and the 'MinuSareeEnabled' flag is set
add:option:vchrefpurcopt:@@ispurchase and @@MinuSareeEnabled

[!field:vchrefpurcopt]
; Add control 'msgaSupplierInvoice' to check for duplicate supplier invoice numbers
; This control is triggered in create mode if 'refnoppt' condition is true
add:control:msgaSupplierInvoice:if @@refnoppt and $$increatemode then yes else no

;;===========================================================
;; System formula definitions

[System: Formula]
; Define 'refnoppt' to check if the current reference matches a reference in the filtered collection
refnoppt: $Reference = $$FilterValue:$Reference:Colsuppinv:1:ColsuppFilter

;;===========================================================
;; Define a collection to fetch vouchers related to the selected ledger (eiconsignee)

[Collection: Colsuppinv]
Type        : Vouchers  : Ledger              ; Fetch vouchers of type Ledger
Child of    : #eiconsignee                    ; Filter for vouchers related to selected consignee
format      : $Reference,10                   ; Display reference field with width 10
format      : $ledgername,30                  ; Display ledger name with width 30
fetch       : Reference, ledgername           ; Fetch these two fields
filter      : ColsuppFilter2                  ; Apply filter defined below

;;===========================================================
;; More system formula definitions for filtering and messages

[system: Formula]
; Filter to match the reference field with the given voucher reference
ColsuppFilter   : $Reference = #vchref

; Get the first matching value from the collection using the filter
colsupp         : $$FilterValue:$Reference:Colsuppinv:1:ColsuppFilter

; Filter to ensure only purchase vouchers are considered
ColsuppFilter2  : $$ispurchase:$vouchertypename

; Alias for the supplier invoice number
SupplierInvoiceNo : $Reference

; Message displayed when a duplicate supplier invoice number is detected
msgaSupplierInvoice : "Supplier Invoice No. Duplicate !"
