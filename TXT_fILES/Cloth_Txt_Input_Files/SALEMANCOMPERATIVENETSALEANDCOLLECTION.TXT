;===============================================================================
; SALEMANCOMPERATIVENETSALEANDCOLLECTION.TXT
; Created By: Khokan on 2022-08-11 14:19, ID:
; Purpose: Implements a "Salesman Comparative Net Sales and Collection" report in Tally,
;          comparing net sales and collections for each salesman/party across two companies
;          and/or two periods, with detailed variation analysis and professional formatting.
;===============================================================================

;;------------------------------------------------------------------------------
;; MENU INTEGRATION: Add report option to Gateway of Tally and Debug menu
;;------------------------------------------------------------------------------

[#menu: Gateway of Tally]
;; Add option for the comparative report (locked/demo logic can be enabled if needed)
;; add: Option: SalemanComperativeNetsaleandCollectionLock ;; : @@SalemanComperativeNetsaleandCollectionDemoLock

[#menu : cw_Debug_menu]
    ;; Add the comparative report to the debug menu for display via collection
    add: Item: before: @@locQuit: @@SalemanComperativeNetsaleandCollectionReport: Display Collection: collRepSalemanComperativeNetsaleCollection
    add: Item: before: @@locQuit: Blank

[System: formula]
    ;; Report title string
    SalemanComperativeNetsaleandCollectionReport: "Saleman Comparative Net Sales and Collection"
;; SalemanComperativeNetsaleandCollectionDemoLock: $$MachineDate < $$Date:"01/04/2013"

;;------------------------------------------------------------------------------
;; MAIN COLLECTION: List of ledgers for selection and report trigger
;;------------------------------------------------------------------------------

[Collection: collRepSalemanComperativeNetsaleCollection]
    Use         		: Extract Alias Collection
    Source	Collection	: List of ledgers
    Title       		: $$LocaleString:"List of"
    Report      		: RepSalemanComperativeNetsaleandCollection
    Variable    		: str1, str2, str3
    variable:ledgername
    Trigger   		: Svcompanyx

;;------------------------------------------------------------------------------
;; REPORT DEFINITION: Comparative Net Sales and Collection
;;------------------------------------------------------------------------------

[Report: RepSalemanComperativeNetsaleandCollection]
    use: Dsp Template
    Title: @@SalemanComperativeNetsaleandCollectionReport
    Printset: Report Title: @@SalemanComperativeNetsaleandCollectionReport
    Form: FrmSalemanComperativeNetsaleandCollection
    Export: Yes
    set  : svfromdate : ##svcurrentdate
    set  : svTodate : ##svcurrentdate
    Local: Button: RelReports: Inactive: Yes
    variable : num1
    set : num1 : $$cwFillDetailssm
    variable:str8,str9
    set:str8:""
    set:str9:""

;;------------------------------------------------------------------------------
;; FORM LAYOUT: Main form for the comparative report
;;------------------------------------------------------------------------------

[Form: FrmSalemanComperativeNetsaleandCollection]
    use: DSP Template
    Part: DspAccTitles, PrtTitle0SalemanComperativeNetsaleandCollection, PrtSalemanComperativeNetsaleandCollection
    Width: 100% Page
    Height: 100% Page
    delete: page break
    add: page break: SalemanComperativeNetsaleandCollectionbotbrk, SalemanComperativeNetsaleandCollectionbotOpbrk
    Bottom Toolbar Buttons: BottomToolBarBtn1, BottomToolBarBtn3, BottomToolBarBtn8, BottomToolBarBtn9, BottomToolBarBtn10, BottomToolBarBtn11, BottomToolBarBtn12
    add:button:smComperativenetbotton

;;------------------------------------------------------------------------------
;; PAGE BREAK PARTS
;;------------------------------------------------------------------------------

[part: SalemanComperativeNetsaleandCollectionbotBrk]
    line: EXPINV PageBreak
    border: thin top

[part: SalemanComperativeNetsaleandCollectionbotopbrk]
    use: dspacctitles
    add: part: SalemanComperativeNetsaleandCollectionTitlePart

;;------------------------------------------------------------------------------
;; TITLE PARTS AND LINES: Display report titles and period info
;;------------------------------------------------------------------------------

[part: SalemanComperativeNetsaleandCollectionTitlePart]
    line: LnSalemanComperativeNetsaleandCollectionTitle, LnSalemanComperativeNetsaleandCollectionTitle2, LnSalemanComperativeNetsaleandCollectionTitle3

[line: LnSalemanComperativeNetsaleandCollectionCurrPeriod]
    field: fwf, fwf2
    Local: field: fwf2: Align: Right
    Local: Field: fwf: Style: normal bold
    Local: Field: fwf2: Style: normal bold
    Local: Field: fwf2: Set As: @@dspDateStr
    invisible: $$inprintmode

[part: PrtTitle0SalemanComperativeNetsaleandCollection]
    line : LnSalemanComperativeNetsaleandCollectionCurrPeriod

;;------------------------------------------------------------------------------
;; MAIN PART: Data lines and totals for the comparative report
;;------------------------------------------------------------------------------

[Part: PrtSalemanComperativeNetsaleandCollection]
    Line: LnSalemanComperativeNetsaleandCollectionTitle, LnSalemanComperativeNetsaleandCollectionTitle2, LnSalemanComperativeNetsaleandCollectionTitle3, LnSalemanComperativeNetsaleandCollection
    bottom Line: LnSalemanComperativeNetsaleandCollectionTotals
    repeat: LnSalemanComperativeNetsaleandCollection: varComperativeNetsalesm
    scroll: Vertical
    Common Border: Yes
    Total: numf, amtf, amtf2, numf2, amtf3, amtf4, numf3, amtf, amtf6, amtf10, amtf11, amtf12, amtf13

;;------------------------------------------------------------------------------
;; COLLECTION: Salesman/Party-wise comparative net sales and collection
;;------------------------------------------------------------------------------

[variable :varComperativeNetsalesm]
    variable : uniqueRow : string
    variable : agentName : String
    variable : varpartyname : string
    variable : varnetsalesqty1 : number
    variable : varnetsalesamt1 : amount
    variable : varnetsalescoll1 : amount
    variable : varnetsalesqty2 : number
    variable : varnetsalesamt2 : amount
    variable : varnetsalescoll2 : amount
    variable : varSaleVariation : amount
    variable : varSaleVarn : amount
    variable : varCollVariation : amount
    variable : varCollVarn : amount

[system : variable]
    list variable : varComperativeNetsalesm

[collection : varComperativeNetsalesm]
    data source: variable : varComperativeNetsalesm
    format : $agentName,10
    format : $varpartyname,10
    format : $varnetsalesqty1,10
    format : $varnetsalesamt1,10
    format : $varnetsalescoll1,10
    format : $varnetsalesqty2,10
    format : $varnetsalesamt2,10
    format : $varnetsalescoll2,10
    format : $varSaleVariation,10
    format : $varSaleVarn,10
    format : $varCollVariation,10
    format : $varCollVarn,10
    filter:cwpartycomfilter,cwcvaragentfilter

;;------------------------------------------------------------------------------
;; FILTERS: For party and agent selection in the comparative report
;;------------------------------------------------------------------------------

[System: Formula]
    ;; Filter for party selection
    ;; cwpartycomfilter:if $$issysname:##str8 then yes else $varpartyname =##str8
    ;; Filter for agent selection
    ;; cwcvaragentfilter:if $$issysname:##str9 then yes else $agentName =##str9

;;------------------------------------------------------------------------------
;; FUNCTION: Fill comparative net sales and collection data for both companies/periods
;;------------------------------------------------------------------------------

[function: cwFillDetailssm]
    ;; Fill data for both companies/periods into the varComperativeNetsalesm variable list
    00 : LIST DELETE	: varComperativeNetsalesm
    02 : set : svfromdate : ##sdf1
    03 : set : svtodate : ##sdf2
    10 : call : cwFillCompanyDetailssm:##str1:##sdf1:##sdf2:1
    14 : set : svfromdate : ##sdf3
    15 : set : svtodate : ##sdf4
    16 : refresh tdl
    18 : set : svCurrentCompany : ##str2
    20 : call : cwFillCompanyDetailssm2:##str2:##sdf3:##sdf4:2

;;------------------------------------------------------------------------------
;; FUNCTION: Fill company-wise net sales and collection details into the variable list
;;------------------------------------------------------------------------------

[function: cwFillCompanyDetailssm]
    parameter : myCompanyName : string
    parameter : asvFromDate : date
    parameter : asvTodate : date
    parameter : fieldNo : number
    ;; ... (see original for detailed variable and logic comments)
    ;; Walks through ColAgentPartyPerformancesm, aggregates sales/coll, stores in varComperativeNetsalesm

[function: cwFillCompanyDetailssm2]
    parameter : myCompanyName : string
    parameter : asvFromDate : date
    parameter : asvTodate : date
    parameter : fieldNo : number
    ;; ... (see original for detailed variable and logic comments)
    ;; Walks through ColAgentPartyPerformancesm2, aggregates sales/coll, stores in varComperativeNetsalesm

;;------------------------------------------------------------------------------
;; COLLECTIONS: Aggregate sales and collection data for each company/period
;;------------------------------------------------------------------------------

[Collection: ColAgentPartyPerformancesm]
    source collection : ColAgentPartyPerformancesmSRc
    by : cwAgentName  : $cwAgentName1
    by : Parent  : $parent
    aggr compute : SaleQty      : sum : $cwSalesDuringThePeriodQty
    aggr compute : SaleValue    : sum : $cwSalesDuringThePeriodAmount
    aggr compute : ReceiptValue : sum : $cwReceiptDuringThePeriod
    sort : @@default : $cwAgentName,$parent
    filter : cwBillsHavingEntries

[System: Formula]
    cwBillsHavingEntries : not ($$isempty:$SaleQty and $$isEmpty:$saleVAlue and $$isempty:$receiptValue)

[Collection: ColAgentPartyPerformancesmSRc]
    Collection: ColAgentPartyPerformancesmPending
    Collection: ColAgentPartyPerformancesmCleared

[Collection: ColAgentPartyPerformancesmPending]
    Type : Bills
    fetch : cwcaption1vch
    fetch : LedgerEntries.InventoryEntries.BilledQty
    compute : cwAgentName1 : if not $$isempty:$cwcaption2vch then $cwcaption2vch else $cwcaption2vch:ledger:$parent
    compute : cwSalesDuringThePeriodQty : $$FilterNumTotal:LedgerEntries:cwSalesCrNoteDuringThePeriod:@@cwQty
    compute : cwSalesDuringThePeriodAmount : $$FilterNumTotal:LedgerEntries:cwSalesCrNoteDuringThePeriod:@@cwFNBillAllocTotal
    compute : cwReceiptDuringThePeriod : $$filterNumTotal:LedgerEntries:cwReceiptsDuringThePeriod:@@cwFNBillAllocTotal
    filter: cwDebtorsBills
    keep source: no

[Collection: ColAgentPartyPerformancesmCleared]
    use : ColAgentPartyPerformancesmPending
    cleared : yes

;; Repeat similar structure for ColAgentPartyPerformancesm2, ColAgentPartyPerformancesmSRc2, etc.

;;------------------------------------------------------------------------------
;; FILTER BUTTON: F7 popup for filtering by agent/salesman
;;------------------------------------------------------------------------------

[button:smComperativenetbotton]
    key:f7
    title:"Filter"
    Action : Modify Variables:smComperativenetbotton

[report:smComperativenetbotton]
    form:smComperativenetbotton

[form:smComperativenetbotton]
    part:smComperativenetbotton
    WIDTH:30

[part:smComperativenetbotton]
    line:titlelinexn1,Customernameline1,smAgentlinex1

[line:smAgentlinex1]
    field:sp,nf
    Local: Field: sp: Set As:$cwcaption2:COMPANY:##SVCURRENTCOMPANY
    Local: Field: nf:modifies:str9
    space bottom:0.5
    Local: field: sp: Width:18
    Local: Field: sp: Style: Normal Bold
    Local: Field:nf:Table : cwcaption2tableundersc, Not Applicable:$cwcaption2table:COMPANY:##SVCURRENTCOMPANY="Stock Category"
    Local: Field:nf:Table : cwcaption2tableunderled, Not Applicable:$cwcaption2table:COMPANY:##SVCURRENTCOMPANY="ledger"
    Local: Field:nf:option:optcc:$cwcaption2table:COMPANY:##SVCURRENTCOMPANY="Cost Centre"
    Local: Field:nf:option:optsc:$cwcaption2table:COMPANY:##SVCURRENTCOMPANY="Stock Category"
    Local: Field:nf:option:optled:$cwcaption2table:COMPANY:##SVCURRENTCOMPANY="ledger"
    Local: Field: nf: Style: Normal Bold

;===============================================================================
; End of SALEMANCOMPERATIVENETSALEANDCOLLECTION.TXT
;===============================================================================
