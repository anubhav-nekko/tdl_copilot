; =============================================================================
;  DAILY SALES REGISTER – DOCUMENTATION
;  ---------------------------------------------------------------------------
;  Original Author : Khokan           •  Created : 2022-04-13 17:34
;  Purpose         : Detailed day-wise sales register with multi-level filters
; =============================================================================


; ============================ 1. MENU INTEGRATION =============================
;  Adds the report to Gateway of Tally and the debug menu
; -----------------------------------------------------------------------------
     [#menu: Gateway of Tally]
;; {13.Apr.22 18:04}         add: Option: DailySalesRegisterLock ;; : @@DailySalesRegisterDemoLock
       
     [#menu : cw_Debug_menu]   
        add: Item: before: @@locQuit: @@DailySalesRegisterReport: Display: RepDailySalesRegister



; ---------------- Optional locking menu (currently unused) --------------------
     [!menu: DailySalesRegisterLock]
        add: Item: before: @@locQuit: @@DailySalesRegisterReport: Display: RepDailySalesRegister
        add: Item: before: @@locQuit: Blank
        

; ========================== 2. SYSTEM-LEVEL FORMULAE ==========================
;  Centralised string constants and demo lock switch
; -----------------------------------------------------------------------------
    [System: formula]
   DailySalesRegisterReport: "Daily Sales Register"
;; DailySalesRegisterDemoLock: $$MachineDate < $$Date:"01/04/2013"



; ============================== 3. MAIN REPORT ================================
;  Sets up variables, default dates and links to the form layout
; -----------------------------------------------------------------------------
    [Report: RepDailySalesRegister]
        use: Dsp Template
      Title: @@DailySalesRegisterReport
   Printset: Report Title: @@DailySalesRegisterReport
       Form: FrmDailySalesRegister
     Export: Yes
     set  : svfromdate : ##svcurrentdate
     set  : svTodate   : ##svcurrentdate
    Local : Button : RelReports : Inactive : Yes

    ; -------- Filter variables (populated via F7 dialog) ----------------------
    variable:str2,str3,str4,str5,str6,str7,str8,str9,str10
    set:str2:""
    set:str3:""
    set:str4:""
    set:str5:""
    set:str6:""
    set:str8:""
    set:str9:""
    set:str10:""



; ============================ 4. FORM LAYOUT =================================
;  Header, body and footer parts (uses standard DSP template)
; -----------------------------------------------------------------------------
      [Form: FrmDailySalesRegister]
        use: DSP Template
       Part: DspAccTitles,PrtTitle0DailySalesRegister,PrtDailySalesRegister
      Width: 100% Page
     Height: 100% Page
 Background: @@SV_STOCKSUMMARY
     delete: page break
        add : page break : DailySalesRegisterbotbrk,DailySalesRegisterbotOpbrk

Bottom Toolbar Buttons : BottomToolBarBtn1, BottomToolBarBtn3, BottomToolBarBtn8, BottomToolBarBtn9, BottomToolBarBtn10, BottomToolBarBtn11,BottomToolBarBtn12
;; 1 Quit • 3 Delete • 8 Remove Line • 9 Restore Line • 10 Restore All • 11 Select • 12 Select All

; --- Print-style overrides for company header ---------------------------------
local:Part:DSPCompanyName       :local:line:DSPCompanyName       : Local: Field: DSP CompanyName    : PrintStyle:styleCalisto2
local:Part:DSPCompanyAddress    :local:line:DSPCompanyAddress    : Local: Field: DSPCompanyAddress  : PrintStyle:style2n
local:Part:DSPReportTitle       :local:line:DSPReportName        : Local: Field: DSPReportName      : PrintStyle:style3n
local:Part:DSPReportSubTitle    :local:line:DSPReportSubTitle    : Local: Field: DSPReportSubTitle  : PrintStyle:style2n
local:Part:DSPReportTitle       :local:line:DSPReportPeriod      : Local: Field: DSPReportPeriod    : PrintStyle:style2n
local:Part:DSPPageNo            :local:line:DSPPageNo            : Local: Field: DSPPageNo          : PrintStyle:style2n

     button:cwsregbottonds                     ; F7 filter button



; --------------------------- Footer page-break parts --------------------------
      [part: DailySalesRegisterbotBrk]
       line : EXPINV PageBreak
     border : thin top

      [part: DailySalesRegisterbotopbrk]
        use: dspacctitles
  add: part: DailySalesRegisterTitlePart

      [part: DailySalesRegisterTitlePart]
       line: LnDailySalesRegisterTitle



; ----------- Caption line displaying the current period (runtime) -------------
      [line: LnDailySalesRegisterCurrPeriod]
      field: fwf,fwf2
      Local: field: fwf2: Align: Right
      Local: Field: fwf2: Set As: @@dspDateStr
  invisible: $$inprintmode

   Local: Field: fwf2: Style:styleCalisto2
   Local: Field: fwf : Style:styleCalisto2



; Wrapper part for the period caption
      [part: PrtTitle0DailySalesRegister]
      line : LnDailySalesRegisterCurrPeriod



; ------------------ Body: header, detail and totals lines ---------------------
      [Part: PrtDailySalesRegister]
       Line       : LnDailySalesRegisterTitle,LnDailySalesRegister
bottom Line : LnDailySalesRegisterTotals
     repeat     : LnDailySalesRegister : ColDailySalesRegister
     scroll     : Vertical
 Common Border : YEs
      Total     : numf,amtf



; ========================== 5. DATA COLLECTION ================================
;  Builds an aggregated sales ledger, with computed columns and filters
; -----------------------------------------------------------------------------
[Collection: ColDailySalesRegister]
source Collection : sourceColDailySalesRegister
walk              : inventoryentries
by:date           : $date
by:vouchernumber  : $vouchernumber
by:partyledgername: $partyledgername
by:stockitemname  : $stockitemname
aggr compute      : billedqty       : $$number:$billedqty
compute           : amount1         : $..amount
compute           : cwledcity1      : $cwledcity          : ledger : $partyledgername
compute           : cwledpincode1   : $pincode            : ledger : $partyledgername
compute           : BillDate1       : @@cwbillOverDue
compute           : cwcaption1vch1  : $..cwcaption1vch
compute           : cwcaption2vch1  : $..cwcaption2vch
compute           : cwcaption3vch1  : $..cwcaption3vch
compute           : masterid        : $masterid

fetch : billdate
; ---- Multi-criteria filters driven by F7 dialog ------------------------------
filter : cwcwledcity1filterds,cwnspartymsnfilterds,cwmsitemnamefilterds,cwnsagentfilterds,cwnssalesmfilternewds,cwareafilterds,cwcwledpincodefilterds


; Formulae implementing each filter variable
 [System: Formula]
cwnspartymsnfilterds     : if $$issysname:##str8  then yes else $partyledgername  = ##str8
cwcwledcity1filterds     : if $$issysname:##str9  then yes else $cwledcity1       = ##str9
cwcwledpincodefilterds   : if $$issysname:##str10 then yes else $cwledpincode1    = ##str10
cwmsitemnamefilterds     : if $$issysname:##str3  then yes else $stockitemname    = ##str3
cwnsagentfilterds        : if $$issysname:##str4  then yes else $cwcaption1vch1   = ##str4
cwnssalesmfilternewds    : if $$issysname:##str5  then yes else $cwcaption2vch1   = ##str5
cwareafilterds           : if $$issysname:##str6  then yes else $cwcaption3vch1   = ##str6



; ------------ Source collection: all Sales vouchers in current company --------
[Collection: sourceColDailySalesRegister]
    Type       : Vouchers : VoucherType
    Child Of   : $$VchTypesales
    Belongs To : Yes

    [system: Formula]
ColDailySalesRegisterFilter : $$issales:$vouchertypename



; Over-due calculation used in BillDate1
[System: Formula]
cwbillOverDue : If ($$IsEmpty:$ClosingBalance AND NOT $$IsEmpty:@BillClearedDate)
                Then @BillClearedDate - @@CreditPeriod
                Else ##DSPToDate - @@CreditPeriod



; =========================== 6. HEADER CAPTIONS ===============================
;  Static labels for each column
; -----------------------------------------------------------------------------
      [Line: LnDailySalesRegisterTitle]
        use   : LnDailySalesRegister
     option   : titleopt
;;   local: field:default: set as: $$DescName

local:field:sdf  : set as: "Date"
local:field:snf  : set as: "Voucher No"
local:field:fwf  : set as: "Party Name"
local:field:snf2 : set as: "Agent"
local:field:snf3 : set as: "Salesperson"
local:field:snf4 : set as: "Area"
local:field:snf5 : set as: "City"
local:field:snf6 : set as: "Pin Code"
local:field:sdf2 : set as: "Over Due Days"
local:field:nf   : set as: "Products"
local:field:numf : set as: "Qty."
local:field:snfx : set as: "UOM"
local:field:amtf : set as: "Amount"

; Apply Calisto style to all caption fields
local:field:sdf,snf,snf1,snf2,snf3,snf4,snf5,snf6,sdf2,snf7,snf8,snf9,nf,fwf,numf,snfx,amtf : style:styleCalisto2
Local: field:default: Align: centre
Local: field:fwf: Align: left



; ============================ 7. DETAIL LINE =================================
;  One line per inventory entry; suppresses repeats for same voucher
; -----------------------------------------------------------------------------
[Line: LnDailySalesRegister]
Fields      : sdf,snf,fwf
right field : snf2,snf3,snf4,snf5,snf6,sdf2,nf,numf,snfx,Amtf
local:field : qtyf : Format : "NoSymbol, Short Form, No Compact,NoZero"
local:field : ratepf : setas : #amtf/#qtyf

; Show data only on first line of each voucher block
local:field:sdf  : set as: if $$line=1 then $date           else if $vouchernumber <> $$prevobj:$vouchernumber then $date           else ""
local:field:snf  : set as: if $$line=1 then $vouchernumber  else if $vouchernumber <> $$prevobj:$vouchernumber then $vouchernumber  else ""
local:field:fwf  : set as: if $$line=1 then $partyledgername else if $vouchernumber <> $$prevobj:$vouchernumber then $partyledgername else ""
local:field:snf2 : set as: if $$line=1 then $cwcaption1vch1 else if $vouchernumber <> $$prevobj:$vouchernumber then $cwcaption1vch1 else ""
local:field:snf3 : set as: if $$line=1 then $cwcaption2vch1 else if $vouchernumber <> $$prevobj:$vouchernumber then $cwcaption2vch1 else ""
local:field:snf4 : set as: if $$line=1 then $cwcaption3vch1 else if $vouchernumber <> $$prevobj:$vouchernumber then $cwcaption3vch1 else ""
local:field:snf5 : set as: if $$line=1 then $cwledcity1     else if $vouchernumber <> $$prevobj:$vouchernumber then $cwledcity1     else ""
local:field:nf   : set as: $stockitemname
local:field:numf : set as: $billedqty
local:field:snfx : set as: $baseunits:stockitem:$stockitemname
local:field:amtf : set as: if $$line=1 then $amount1        else if $vouchernumber <> $$prevobj:$vouchernumber then $amount1        else ""
local:field:snf6 : set as: if $$line=1 then $cwledpincode1  else if $vouchernumber <> $$prevobj:$vouchernumber then $cwledpincode1  else ""
Local:Field:sdf2 : Set As: if $$line=1 then $BillDate1      else if $vouchernumber <> $$prevobj:$vouchernumber then $BillDate1      else ""

add:option:cwalterVch                     ; (assumes option defined elsewhere)
local: field: DEFAULT : style:styleCalisto
Local: Field: default : Border: thin right



; ============================ 8. TOTALS LINE =================================
;  Shows aggregated Qty and Amount
; -----------------------------------------------------------------------------
[line: LnDailySalesRegisterTotals]
use   : LnDailySalesRegister
option: totalOpt
local : field : fwf : align: right

local:field:sdf  : set as:""
local:field:snf  : set as:""
local:field:fwf  : set as:"Total"
local:field:snf2 : set as:""
local:field:snf3 : set as:""
local:field:snf4 : set as:""
local:field:snf5 : set as:""
local:field:nf   : set as:""
local:field:numf : set as:$$total:numf
local:field:snfx : set as:""
local:field:amtf : set as:$$total:amtf

; Apply style to totals line
local:field:sdf,snf,snf1,snf2,snf3,snf4,snf5,nf,fwf,numf,snfx,amtf : style:styleCalisto2



; ============================ 9. FILTER BUTTON ================================
;  F7 dialog captures filter criteria into variables str3-str10
; -----------------------------------------------------------------------------
[button:cwsregbottonds]
 key   : f7
 title : "Filter"
 Action: Modify Variables:cwsregbottonds



; ----------------------------- Filter pop-up ----------------------------------
 [report:cwsregbottonds]
 form:cwsregbottonds

 [form:cwsregbottonds]
 part:cwsregbottonds
 HEIGHT:30                                  ;; % PAGE
 WIDTH :30                                  ;; % PAGE

 [part:cwsregbottonds]
 line:titlelinexns,customernslineds,cwnsstkledlineds,Agentsmnslinexds,salesmnslinexds,arealinexds,cwcwledcitylineDS,cwPinCodeLine



; -------- Individual filter fields (Party, Item, Agent, etc.) -----------------
 [line:customernslineds]
 field:sp,nf
 Local: Field: sp: Set As:"Party Name"
 Local: Field: nf:modifies:str8
 space bottom:0.5
 Local: field: sp: Width:12
 Local: Field: sp: Style: Normal Bold
 Local: Field: nf: table:cwledms, Not Applicable
 Local: Field: nf: Show table: Always
 Local: field: nf: Width:30


 [line:cwnsstkledlineds]
 field:sp,nf
 Local: Field: sp: Set As:"Item Name"
 Local: Field: nf:modifies:str3
 space bottom:0.5
 Local: field: sp: Width:12
 Local: Field: sp: Style: Normal Bold
 Local: Field: nf: table:stockitem, Not Applicable
 Local: Field: nf: Show table: Always
 Local: field: nf: Width:30


 [line:Agentsmnslinexds]
 field:sp,nf
 Local: Field: sp: Set As:"Agent Name"
 Local: Field: nf:modifies:str4
 space bottom:0.5
 Local: field: sp: Width:12
 Local: Field: sp: Style: Normal Bold
 Local: Field: nf: table:cwcaption1tableunderled, Not Applicable
 Local: Field: nf: Show table: Always
 Local: field: nf: Width:30


  [line:salesmnslinexds]
 field:sp,nf
 Local: Field: sp: Set As:"Sales Man"
 Local: Field: nf:modifies:str5
 space bottom:0.5
 Local: field: sp: Width:12
 Local: Field: sp: Style: Normal Bold
 Local: Field: nf: table:cwcaption2tableunderled, Not Applicable
 Local: Field: nf: Show table: Always
 Local: field: nf: Width:30


     [line:arealinexds]
 field:sp,nf
 Local: Field: sp: Set As:"Area"
 Local: Field: nf:modifies:str6
 space bottom:0.5
 Local: field: sp: Width:12
 Local: Field: sp: Style: Normal Bold
 Local: field: nf: Width:30


  [line:cwcwledcitylineDS]
 field:sp,nf
 Local: Field: sp: Set As:"City"
 Local: Field: nf:modifies:str9
 space bottom:0.5
 Local: field: sp: Width:12
 Local: Field: sp: Style: Normal Bold
 Local: field: nf: Width:30


[line:cwPinCodeLine]
field:sp,nf
Local: Field: sp: Set As:"Pincode"
Local: Field: nf:modifies:str10
space bottom:0.5
Local: field: sp: Width:12
Local: Field: sp: Style: Normal Bold
Local: field: nf: Width:30



; ============================ END OF FILE =====================================