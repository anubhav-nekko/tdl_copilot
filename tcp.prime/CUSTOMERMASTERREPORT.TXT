; =============================================================================
;  CUSTOMER MASTER REPORT – DOCUMENTATION
;  ---------------------------------------------------------------------------
;  Original Author : Khokan            •  Created : 2022-02-26 15:38
;  Documentation   : 2025-05-23        •  Scope   : Enterprise readability
; =============================================================================


; ============================= 1. STYLE DEFINITIONS ===========================
;  Two basic font styles used throughout the report
; -----------------------------------------------------------------------------
[style:style1n]                          ; Bold style for titles / headers
 font:"Times New Roman"
 bold:yes
 height:9

 [style:style2nx]                        ; Normal style for data rows
 font:"Times New Roman"
 bold:no
 height:9



; ============================ 2. MENU INTEGRATION =============================
;  Adds the Customer-Master option to Gateway of Tally and Debug menu
; -----------------------------------------------------------------------------
     [#menu: Gateway of Tally]
       ;; add: Option: CustomerMasterreportLock ;; : @@CustomerMasterreportDemoLock

     [#menu : cw_Debug_menu]
        add: Item: before: @@locQuit: @@CustomerMasterreportReport: Display: RepCustomerMasterreport



; --------------------------- Hidden Locking Menu ------------------------------
     [!menu: CustomerMasterreportLock]
        add: Item: before: @@locQuit: @@CustomerMasterreportReport: Display collection : collRepCustomerMasterreport  ;;: RepCustomerMasterreport
        add: Item: before: @@locQuit: Blank



; ========================== 3. SYSTEM-LEVEL FORMULAE ==========================
;  Centralised formulae for easy maintenance
; -----------------------------------------------------------------------------
    [System: formula]
   CustomerMasterreportReport: "Ledger Master"
;; CustomerMasterreportDemoLock: $$MachineDate < $$Date:"01/04/2013"



; ============================= 4. GROUP PICKER ================================
;  Prompts the user to choose a Ledger Group (Sundry Debtors / Creditors)
; -----------------------------------------------------------------------------
[collection : collRepCustomerMasterreport]

 Use         : List of Groups            ;; Inherits “List of Groups”
    ;;Collection  : Primary
    Variable    : Group Name             ; Stores selected group

    Trigger     : GroupNamexms           ; Opens auto-report
	Fetch		: Name                  ; Needed for display



; Forward declaration of main report (defined later)
Report: RepCustomerMasterreport



; ------------------------- Auto-Report: GroupNamexms --------------------------
 [Report: GroupNamexms]   ;; Lets user pick the group

            Use     : Collection Variable
            Local   : Line : Collection Variable : Field : GroupNamexms
            Local   : Field: MV Title            : Info  : $$LocaleString:"Name of Group"

            [Field: GroupNamexms]
          Use         : Name Field
          Key         : Create group
          Modifies    : Group Name
          Table       : collledgrx              ;; Filtered list of groups
          Show Table  : Always
          CommonTable : No



; Helper collection providing only Debtors / Creditors groups
   [Collection: collledgrx]
   type:Group
   TITLE:"List of Group Name"
   add:filter:mycwGroup

   [System: Formula]
   mycwGroup:$$isbelongsto:$$groupsundrydebtors or $$isbelongsto:$$groupsundrycreditors
;; {26.Feb.22 17:22}    mycwGroup:$$groupsundrydebtors or $$groupsundrycreditors



; ============================== 5. MAIN REPORT ================================
;  Generates the Customer/Ledger master with advanced filters
; -----------------------------------------------------------------------------
    [Report: RepCustomerMasterreport]
        use: Dsp Template
      Title: @@CustomerMasterreportReport
   Printset: Report Title: @@CustomerMasterreportReport
       Form: FrmCustomerMasterreport
     Export: Yes                          ; Allows Excel/PDF export
     set  : svfromdate : ##svcurrentdate  ; Default period: Today
     set  : svTodate   : ##svcurrentdate
    Local : Button : RelReports : Inactive : Yes  ; Disable RelReports button

     ; Variables that capture filter selections from the F7 pop-up
     variable:str1,str2,str3,str4,str5,str6,str7,str8,str9
     set:str1:""
     set:str2:""
     set:str3:""
     set:str4:""
     set:str5:""
     set:str6:""
     set:str7:""
     set:str8:""
     set:str9:""



; ============================ 6. FORM LAYOUT ==================================
;  Composed of header, body and footer parts
; -----------------------------------------------------------------------------
      [Form: FrmCustomerMasterreport]
        use: DSP Template
       Part: DspAccTitles,PrtTitle0CustomerMasterreport,PrtCustomerMasterreport
      Width: 100% Page
     Height: 100% Page
 Background: @@SV_STOCKSUMMARY
     delete: page break
        add: page break: CustomerMasterreportbotbrk,CustomerMasterreportbotOpbrk

Bottom Toolbar Buttons : BottomToolBarBtn1, BottomToolBarBtn3, BottomToolBarBtn8, BottomToolBarBtn9, BottomToolBarBtn10, BottomToolBarBtn11,BottomToolBarBtn12
;; 1 Quit • 3 Delete • 8 Remove Line • 9 Restore Line • 10 Restore All • 11 Select • 12 Select All
    add:button:customerbotton            ; F7 = open filter dialog



; ------------------------------ Footer parts ----------------------------------
      [part: CustomerMasterreportbotBrk]
       line: EXPINV PageBreak
     border: thin top

      [part: CustomerMasterreportbotopbrk]
        use: dspacctitles
  add: part: CustomerMasterreportTitlePart

      [part: CustomerMasterreportTitlePart]
       line: LnCustomerMasterreportTitle



; ------------------ Caption line showing Group & Date range -------------------
      [line: LnCustomerMasterreportCurrPeriod]
      field: fwf,fwf2
      Local: field: fwf2: Align: Right
      Local: Field: fwf: Style: Style1n
      Local: Field: fwf2: Style: Style1n
      Local: Field: fwf: Set As: ##GroupName
      Local: Field: fwf2: Set As: @@dspDateStr
  Local: Field: fwf2::invisible: $$inprintmode



; Wrapper for the period caption above
      [part: PrtTitle0CustomerMasterreport]
      line : LnCustomerMasterreportCurrPeriod



; ---------------------- Body: header, detail, totals --------------------------
      [Part: PrtCustomerMasterreport]
       Line: LnCustomerMasterreportTitle,LnCustomerMasterreport
bottom Line: LnCustomerMasterreportTotals
     repeat: LnCustomerMasterreport: ColCustomerMasterreport
     scroll:BOTH                           ;; Horizontal + vertical scroll
 Common Border: YEs
      Total: Qtyf,amtf                     ; Totals declaration



; ======================== 7. DETAIL DATA COLLECTION ===========================
;  Collects ledgers under the chosen group and applies all filters
; -----------------------------------------------------------------------------
[Collection: ColCustomerMasterreport]
type:LEDGER
 child of:##GroupName
 belongs to:yes
filter:cwlednamefilter,cwTransportermsfilter,cwSalespersonfilter,CWASMfilter,CWAgentfilter,CWRSMfilter,CWledCityfilter,CWledZonefilter,cwLedStateNamefilter



; --------------------- Formulae implementing each filter ----------------------
 [System: Formula]
cwlednamefilter      : if $$issysname:##str1 then yes else $name                 = ##str1
cwSalespersonfilter  : if $$issysname:##str2 then yes else $cwcaption1item       = ##str2
CWASMfilter          : if $$issysname:##str3 then yes else $cwcaption2item       = ##str3
CWAgentfilter        : if $$issysname:##str4 then yes else $cwcaption3item       = ##str4
CWRSMfilter          : if $$issysname:##str5 then yes else $cwcaption4item       = ##str5
CWledCityfilter      : if $$issysname:##str6 then yes else $cwcaption5item       = ##str5
CWledZonefilter      : if $$issysname:##str7 then yes else $cwcaption6item       = ##str7
cwLedStateNamefilter : if $$issysname:##str8 then yes else $LedStateName         = ##str8
cwTransportermsfilter: if $$issysname:##str9 then yes else $cwtempGSTewayTransporterName = ##str9



; ========================== 8. HEADER CAPTION LINE ============================
;  Static text labels for each column
; -----------------------------------------------------------------------------
      [Line: LnCustomerMasterreportTitle]
        use: LnCustomerMasterreport
     option: titleopt                       ; Applies bold/border
;;     local: field:default: set as: $$DescName

; --- Column labels ------------------------------------------------------------
local:field: fwf   : set as: "Customer Name"
local:field: NF    : set as: "Customer Code"
local:field: NF1   : set as: "Transporter Name"
local:field: NF2   : set as: "Group"
local:field: AMTF  : set as: "Credit Limit"
local:field: SNF   : set as: "Credit Days"

local:field: NF3   : set as: $cwcaption1:COMPANY:##SVCURRENTCOMPANY
local:field: SNF2  : set as: $cwcaption2:COMPANY:##SVCURRENTCOMPANY
local:field: NF4   : set as: $cwcaption3:COMPANY:##SVCURRENTCOMPANY
local:field: NF5   : set as: $cwcaption4:COMPANY:##SVCURRENTCOMPANY
local:field: NF9   : set as: $cwcaption5:COMPANY:##SVCURRENTCOMPANY
local:field: NF10  : set as: $cwcaption6:COMPANY:##SVCURRENTCOMPANY

local:field: NF6   : set as: "Address-1"
local:field: NF7   : set as: "Address-2"
local:field: NF8   : set as: "Address-3"
local:field: SNF3  : set as: "City"
local:field: SNF4  : set as: "Zone"
local:field: SNF5  : set as: "State"
local:field: SNF6  : set as: "Pincode"
local:field: SNF7  : set as: "Country"
local:field: SNF8  : set as: "Contact Person Name"
local:field: SNF9  : set as: "Mobile No."
local:field: SNF1  : set as: "Phone No."
local:field: SNF10 : set as: "Email Address"
local:field: SNF11 : set as: "GSTN Number"
local:field: SNF12 : set as: "PAN Number"

Local: field: DEFAULT: Align:centre
Local: field: FWF: Align:LEFT

; Apply bold style to all header fields
local:field: fwf,NF,NF1,NF2,AMTF,SNF,SNF1,NF3,SNF2,NF4,NF5,NF6,NF7,NF8,NF9,NF10,NF11,SNF3,SNF4,SNF5,SNF6,SNF7,SNF8,SNF9,SNF10,SNF11,SNF12 : style:style1n



; ============================ 9. DETAIL LINE =================================
;  Single ledger row: pulls data for all columns
; -----------------------------------------------------------------------------
[Line: LnCustomerMasterreport]
Fields:fwf
right field:NF,NF2,AMTF,nf1,NF3,SNF2,NF4,NF5,nf9,nf10,NF6,NF7,NF8,SNF3,SNF5,SNF6,SNF7,SNF8,snf1,SNF9,SNF10,SNF11,SNF12

option : alter on enter
local  : field : fwf : alter : ledger : $$isledger

; --- Data binding for each field ---------------------------------------------
local:field: fwf  : set as:$name                                   ;; Customer Name
local:field: NF   : set as:$$ReptField:Name:2:ledger:#fwf          ;; Customer Code
local:field: NF2  : set as:$parent                                 ;; Group
local:field: AMTF : set as:$CreditLimit                            ;; Credit Limit
local:field: SNF  : set as:$BillCreditPeriod                       ;; Credit Days

local:field: NF1  : set as:$cwtempGSTewayTransporterName           ;; Transporter
local:field: NF3  : set as:$cwcaption1item                         ;; Salesperson
local:field: SNF2 : set as:$cwcaption2item                         ;; ASM
local:field: NF4  : set as:$cwcaption3item                         ;; Agent
local:field: NF5  : set as:$cwcaption4item                         ;; RSM
local:field: NF9  : set as:$cwcaption5item                         ;; City (custom)
local:field: NF10 : set as:$cwcaption6item                         ;; Zone (custom)

local:field: NF6  : set as:$$Collectionfield:$address:1:PartyAddressx ;; Address-1
local:field: NF7  : set as:$$Collectionfield:$address:2:PartyAddressx ;; Address-2
local:field: NF8  : set as:$$Collectionfield:$address:3:PartyAddressx ;; Address-3
local:field: SNF3 : set as:$cwledcity                              ;; City
local:field: SNF4 : set as:""                                      ;; Zone (blank)
local:field: SNF5 : set as:$LedStateName                           ;; State
local:field: SNF6 : set as:$pincode                                ;; Pincode
local:field: SNF7 : set as:$CountryofResidence                     ;; Country
local:field: SNF8 : set as:$LedgerContact                          ;; Contact Person
local:field: SNF1 : set as:$LedgerPhone                            ;; Phone
local:field: SNF9 : set as:$LedgerMobile                           ;; Mobile
local:field: SNF10: set as:$EMail                                  ;; Email
local:field: SNF11: set as:$PARTYGSTIN                             ;; GSTN
local:field: SNF12: set as:$incometaxnumber                        ;; PAN

; Presentation tweaks
Local : field : NF6,NF7,NF8 : Lines : 0
Local : field : fwf : Width : 50
Local : field : nf  : Width : 40
Local : Field : DEFAULT : Border : thin right
Local : field : AMTF : Format : "DRCR"
local : field : default : style:style2nx



; ------------ Helper collection for address extraction per ledger ------------
[collection : partyaddressx]
  type : address : ledger
  child of : $name



; =========================== 10. TOTALS LINE =================================
;  Grand total (only Credit Limit shown)
; -----------------------------------------------------------------------------
[line: LnCustomerMasterreportTotals]
use: LnCustomerMasterreport
option: totalOpt                        ; Underline / bold

; Blank most columns, show “Total” and aggregated Credit Limit
local:field: fwf   : set as:"Total"
local:field: NF..SNF12 : set as:""
local: field: amtf : set as :  $$total:amtf

; Apply bold style
local:field: fwf,NF,NF2,AMTF,SNF,NF3,SNF2,NF4,NF5,NF6,NF7,NF8,SNF3,SNF4,SNF5,SNF6,SNF7,SNF8,SNF9,SNF10,SNF11,SNF12 : style:style1n



; ========================== 11. FILTER BUTTON (F7) ============================
;  Opens modal form to set variables str1-str9
; -----------------------------------------------------------------------------
 [button:customerbotton]
 key:f7
 title:"Filter"
 Action : Modify Variables:customerbotton



; --------------------------- Filter pop-up report -----------------------------
 [report:customerbotton]
 form:customerbotton

 [form:customerbotton]
 part:customerbotton
;; {26.Feb.22 17:54}  HEIGHT:20% PAGE
 WIDTH:30                                 ;; % of page



; --------------------------- Filter pop-up parts ------------------------------
 [part:customerbotton]
 line:titlelinexn,Customernameline,cwTransporternameLEDline2,Salespersonlinex,ASMlinex,Agentlinex,RSMlinex,Citylinex,Zonelinex,Statelinex



; Title of the filter dialog
 [line:titlelinexn]
 field:fwfc
 Local: Field: fwfc: info:"Filter"
 Local: Field: fwfc: Border: thin bottom
 Local: Field: fwfc: Style: Normal Bold
 space bottom:0.5



; -------------- Individual filter lines (Customer, Salesperson, etc.) --------
 [line:Customernameline]
 field:sp,nf
 Local: Field: sp: Set As:"Customer Name"
 Local: Field: nf:modifies:str1
 space bottom:0.5
 Local: field: sp: Width:18
 Local: Field: sp: Style: Normal Bold
 Local: Field: nf: table:collcCustomer,Not Applicable
 Local: Field: nf: Show table: Always



; Lookup collection for Customer filter
 [Collection: collcCustomer]
 type:ledger
 title:"List of Ledger"



[line:Salespersonlinex]
; Re-uses dynamic captions defined in company
 field:sp,nf
 Local: Field: sp: Set As:$cwcaption1:COMPANY:##SVCURRENTCOMPANY
 Local: Field: nf:modifies:str2
 space bottom:0.5
 Local: field: sp: Width:18
 Local: Field: sp: Style: Normal Bold
; Table selection logic depends on caption table type
Local: Field:nf:Table : cwcaption1tableundersc, Not Applicable:$cwcaption1table:COMPANY:##SVCURRENTCOMPANY="Stock Category"
Local: Field:nf:Table : cwcaption1tableunderled, Not Applicable:$cwcaption1table:COMPANY:##SVCURRENTCOMPANY="ledger"
Local: Field:nf:option:optcc :$cwcaption1table:COMPANY:##SVCURRENTCOMPANY="Cost Centre"
Local: Field:nf:option:optsc:$cwcaption1table:COMPANY:##SVCURRENTCOMPANY="Stock Category"
Local: Field:nf:option:optled:$cwcaption1table:COMPANY:##SVCURRENTCOMPANY="ledger"
Local: Field: nf: Style: Normal Bold



[line:ASMlinex]
 field:sp,nf
 Local: Field: sp: Set As:$cwcaption2:COMPANY:##SVCURRENTCOMPANY
 Local: Field: nf:modifies:str3
 space bottom:0.5
 Local: field: sp: Width:18
 Local: Field: sp: Style: Normal Bold
Local:Field:nf:table:cwcaption2tableundercc,Not Applicable:$cwcaption2table:COMPANY:##SVCURRENTCOMPANY="Cost Centre"
Local:Field:nf:Show table: Always
Local: Field:nf:Table      : cwcaption2tableundersc, Not Applicable:$cwcaption2table:COMPANY:##SVCURRENTCOMPANY="Stock Category"
Local: Field:nf:Table      : cwcaption2tableunderled, Not Applicable:$cwcaption2table:COMPANY:##SVCURRENTCOMPANY="ledger"
Local: Field:nf:option:optcc :$cwcaption2table:COMPANY:##SVCURRENTCOMPANY="Cost Centre"
Local: Field:nf:option:optsc:$cwcaption2table:COMPANY:##SVCURRENTCOMPANY="Stock Category"
Local: Field:nf:option:optled:$cwcaption2table:COMPANY:##SVCURRENTCOMPANY="ledger"
Local: Field: nf: Style: Normal Bold



[line:Agentlinex]
 field:sp,nf
 Local: Field: sp: Set As:$cwcaption3:COMPANY:##SVCURRENTCOMPANY
 Local: Field: nf:modifies:str4
 space bottom:0.5
 Local: field: sp: Width:18
 Local: Field: sp: Style: Normal Bold
Local:Field:nf:table:cwcaption3tableundercc,Not Applicable:$cwcaption3table:COMPANY:##SVCURRENTCOMPANY="Cost Centre"
Local:Field:nf:Show table: Always
Local: Field:nf:Table      : cwcaption3tableundersc, Not Applicable:$cwcaption3table:COMPANY:##SVCURRENTCOMPANY="Stock Category"
Local: Field:nf:Table      : cwcaption3tableunderled, Not Applicable:$cwcaption3table:COMPANY:##SVCURRENTCOMPANY="ledger"
Local: Field:nf:option:optcc :$cwcaption3table:COMPANY:##SVCURRENTCOMPANY="Cost Centre"
Local: Field:nf:option:optsc:$cwcaption3table:COMPANY:##SVCURRENTCOMPANY="Stock Category"
Local: Field:nf:option:optled:$cwcaption3table:COMPANY:##SVCURRENTCOMPANY="ledger"
Local: Field: nf: Style: Normal Bold



[line:RSMlinex]
 field:sp,nf
 Local: Field: sp: Set As:$cwcaption4:COMPANY:##SVCURRENTCOMPANY
 Local: Field: nf:modifies:str5
 space bottom:0.5
 Local: field: sp: Width:18
 Local: Field: sp: Style: Normal Bold
Local:Field:nf:table:cwcaption4tableundercc,Not Applicable:$cwcaption4table:COMPANY:##SVCURRENTCOMPANY="Cost Centre"
Local:Field:nf:Show table: Always
Local: Field:nf:Table      : cwcaption4tableundersc, Not Applicable:$cwcaption4table:COMPANY:##SVCURRENTCOMPANY="Stock Category"
Local: Field:nf:Table      : cwcaption4tableunderled, Not Applicable:$cwcaption4table:COMPANY:##SVCURRENTCOMPANY="ledger"
Local: Field:nf:option:optcc :$cwcaption4table:COMPANY:##SVCURRENTCOMPANY="Cost Centre"
Local: Field:nf:option:optsc:$cwcaption4table:COMPANY:##SVCURRENTCOMPANY="Stock Category"
Local: Field:nf:option:optled:$cwcaption4table:COMPANY:##SVCURRENTCOMPANY="ledger"
Local: Field: nf: Style: Normal Bold



[line:Citylinex]
 field:sp,nf
 Local: Field: sp: Set As:$cwcaption5:COMPANY:##SVCURRENTCOMPANY
 Local: Field: nf:modifies:str6
 space bottom:0.5
 Local: field: sp: Width:18
 Local: Field: sp: Style: Normal Bold
Local:Field:nf:table:cwcaption5tableundercc,Not Applicable:$cwcaption5table:COMPANY:##SVCURRENTCOMPANY="Cost Centre"
Local:Field:nf:Show table: Always
;; {21.Jan.20 16:49} local:field:nf:key:Create Cost Centre, Alter CstCtr
Local: Field:nf:Table      : cwcaption5tableundersc, Not Applicable:$cwcaption5table:COMPANY:##SVCURRENTCOMPANY="Stock Category"
Local: Field:nf:Table      : cwcaption5tableunderled, Not Applicable:$cwcaption5table:COMPANY:##SVCURRENTCOMPANY="ledger"
Local: Field:nf:option:optcc :$cwcaption5table:COMPANY:##SVCURRENTCOMPANY="Cost Centre"
Local: Field:nf:option:optsc:$cwcaption5table:COMPANY:##SVCURRENTCOMPANY="Stock Category"
Local: Field:nf:option:optled:$cwcaption5table:COMPANY:##SVCURRENTCOMPANY="ledger"
Local: Field: nf: Style: Normal Bold



 [line:Zonelinex]
 field:sp,nf
 Local: Field: sp: Set As:$cwcaption6:COMPANY:##SVCURRENTCOMPANY
 Local: Field: nf:modifies:str7
 space bottom:0.5
 Local: field: sp: Width:18
Local:Field:nf:table:cwcaption6tableundercc,Not Applicable:$cwcaption6table:COMPANY:##SVCURRENTCOMPANY="Cost Centre"
Local:Field:nf:Show table: Always
Local: Field:nf:Table      : cwcaption6tableundersc, Not Applicable:$cwcaption6table:COMPANY:##SVCURRENTCOMPANY="Stock Category"
Local: Field:nf:Table      : cwcaption6tableunderled, Not Applicable:$cwcaption6table:COMPANY:##SVCURRENTCOMPANY="ledger"
Local: Field:nf:option:optcc :$cwcaption6table:COMPANY:##SVCURRENTCOMPANY="Cost Centre"
Local: Field:nf:option:optsc:$cwcaption6table:COMPANY:##SVCURRENTCOMPANY="Stock Category"
Local: Field:nf:option:optled:$cwcaption6table:COMPANY:##SVCURRENTCOMPANY="ledger"
Local: Field: nf: Style: Normal Bold



[line:Statelinex]
 field:sp,nf
 Local: Field: sp: Set As:"State"
 Local: Field: nf:modifies:str8
 space bottom:0.5
 Local: field: sp: Width:18
 Local: Field: sp: Style: Normal Bold
 Local: Field: nf: table:Indian States,Not Applicable
 Local: Field: nf: Show table: Always



; ---------------- Transporter Name filter line -------------------------------
[Line:cwTransporternameLEDline2]
 Field  : sp,nf
 Local  : Field : sp : Set as : $$LocaleString:"Transporter Name"
; NOTE: Table refers to “collTransporterled”, which must exist in the system.
;       No collection definition is added here to honour the “no code changes”
;       requirement. Ensure such a collection is defined elsewhere.
 Local: Field: nf: Style: Normal Bold
 Local: Field: nf: table:collTransporterled,Not Applicable
 Local: Field: nf: Show table: Always
 Local: Field: nf:modifies:str9
 space bottom:0.5
 Local: field: sp: Width:18
 Local: Field: sp: Style: Normal Bold
 Local: Field: nf:modifies:str9



; ============================ END OF FILE =====================================